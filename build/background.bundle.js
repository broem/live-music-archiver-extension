(()=>{"use strict";function e(){let e=null,t=null,o=null;return new Promise(((r,n)=>{chrome.storage.session.get(["config","userId","userEmail"],(n=>{console.log("RESPONSE"),console.log(n),e=n.config,t=n.userId,o=n.userEmail,r({config:e,userId:t,userEmail:o})}))}))}let t=0,o=0,r=0,n=0;function c(e,t){if(0==e.length)return 0;for(var o=[0],r=1;r<e.length;r++){for(var n=o[r-1];n>0&&e.charAt(r)!=e.charAt(n);)n=o[n-1];e.charAt(r)==e.charAt(n)&&n++,o.push(n)}for(n=0,r=0;r<t.length;r++){for(;n>0&&t.charAt(r)!=e.charAt(n);)n=o[n-1];if(t.charAt(r)==e.charAt(n)&&++n==e.length)return r-(n-1)}return-1}fetch("./config.json").then((e=>e.json())).then((e=>{chrome.storage.session.set({config:e},(function(){console.log("config data set to local storage"),console.log("checking user"),console.log("check user"),chrome.storage.session.get(["userId"],(function(e){console.log(e)}))}))})),chrome.action.onClicked.addListener((()=>{chrome.tabs.create({url:chrome.runtime.getURL("popup.html"),active:!1},(async function(e){console.log("tab created"),await chrome.windows.create({tabId:e.id,type:"popup",focused:!0,height:628,width:628}).then((()=>{popUpTabId=e.id})).catch((e=>{console.log(e)}))})),chrome.tabs.query({active:!0,currentWindow:!0},(function(e){e.forEach((e=>{null!=e.url&&null!=e.url&&e.url.length>0&&-1==c("chrome",e.url)&&chrome.scripting.executeScript({target:{tabId:e.id},files:["./selectElements.js"]}).then((()=>{console.log("selectElements.js injected")})).catch((e=>{console.error(e)}))}))})),chrome.identity.getProfileUserInfo({accountStatus:"ANY"},(function(e){console.log("checking user info"),chrome.storage.session.set({userId:e.id}),chrome.storage.session.set({userEmail:e.email}),console.log("getting user"),async function(){console.log("dededeee user"),await async function(){console.log("Getting user"),chrome.storage.session.get(["userEmail","config","userId"],(async function(e){var t=e.config,o=e.userEmail,r={user_id:e.userId,email:o};console.log(o);var n="http://"+t["remote-address"]+"/api/user";console.log(n),await fetch(n,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{Authorization:"Bearer null","Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(r)}).then((e=>e.json())).then((e=>{console.log(e),chrome.storage.session.set({user:JSON.stringify(e)})})).catch((e=>{console.log(e)}))}))}().then((e=>{console.log(e)})).catch((e=>{console.log(e)}))}()}))})),chrome.tabs.onUpdated.addListener((function(e,t,o){null!=o.url&&null!=o.url&&o.url.length>0&&-1==c("chrome",o.url)&&chrome.scripting.executeScript({target:{tabId:o.id},files:["selectElements.js"]})})),chrome.runtime.onInstalled.addListener((()=>{})),chrome.contextMenus.onClicked.addListener((function(e,t){if("BRING_BACK_POP"!==e.menuItemId)return;chrome.tabs.query({active:!0,currentWindow:!0},(function(e){chrome.scripting.executeScript({target:{tabId:e[0].id},files:["bringBackPopContext.js"]})}))})),chrome.storage.session.setAccessLevel({accessLevel:"TRUSTED_AND_UNTRUSTED_CONTEXTS"}),chrome.runtime.onMessage.addListener((async function(s,a,i){if("Select elements"===s.selectElements){console.log("select elements"),t+=1;let e={field:s.field,label:s.label,updator:t};chrome.storage.sync.set({selectElements:JSON.stringify(e)})}if("removeElement"===s.msg){t+=1;let e={field:s.field,updator:t};chrome.storage.sync.set({removeElement:JSON.stringify(e)})}if("openTab"===s.msg&&chrome.tabs.create({url:s.url}).then((e=>{console.log("tab created"),chrome.scripting.executeScript({target:{tabId:e.id},files:["selectElements.js"]})})),"highlightElements"===s.msg){console.log("highlight elements"),chrome.storage.sync.get(["highlightElements"],(function(e){elems=JSON.parse(e),o=elems.updator})),o+=1;let e={highlightElements:s.data,updator:o};chrome.storage.sync.set({highlightElements:JSON.stringify(e)})}"Select all tagged elements"===s.selectAllTaggedElements&&(r+=1,chrome.storage.sync.set({selectAllIndex:r})),"Disable select"===s.disableSelect&&(n+=1,chrome.storage.sync.set({disableSelect:n})),"GetIGScrapes"===s.msg&&await async function(){chrome.storage.session.get(["userId","config"],(async function(e){var t=e.config;await fetch("http://"+t["remote-address"]+"/api/getCurrentIGScrapeEvents/"+e.userId,{method:"GET",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{Authorization:"Bearer null","Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer"}).then((e=>e.json())).then((e=>{chrome.storage.session.set({scrapeIGEvents:e})})).catch((e=>{console.log(e)}))}))}(),"updateIGScrape"===s.msg&&await async function(e){chrome.storage.session.get("config",(async function(t){const o=t.config;await fetch("http://"+o["remote-address"]+"/api/updateIGScrape",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{Authorization:"Bearer null","Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(e)}).then((e=>e.json())).then((e=>{})).catch((e=>{console.log(e)}))}))}(s.data),"deleteIGScrape"===s.msg&&await async function(e){chrome.storage.session.get("config",(async function(t){const o=t.config;await fetch("http://"+o["remote-address"]+"/api/deleteIGScrape",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{Authorization:"Bearer null","Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(e)}).then((e=>e.json())).then((e=>{})).catch((e=>{console.log(e)}))}))}(s.data),"Download recent"===s.msg&&await async function(t){let o=await e(),r=o.config,n=o.userId;t&&(n=t.userId);try{let e=await fetch("http://"+r["remote-address"]+"/api/myScrapes/"+n,{method:"GET",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{Authorization:"Bearer null","Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer"});return 200==e.status?await e.blob():(console.log("bad status"),null)}catch(e){return console.log(e),null}}().then((e=>{})),"downloadIGRecent"===s.msg&&await async function(e){chrome.storage.session.get(["userId","config"],(async function(t){var o=t.config;await fetch("http://"+o["remote-address"]+"/api/myIgScrapes/"+t.userId,{method:"GET",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{Authorization:"Bearer null","Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(e)}).then((e=>e.text())).then((e=>{chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(t){var o=t[0];chrome.tabs.sendMessage(o.id,{msg:"recentIGScrapes",data:e})}))})).catch((e=>{console.log(e)}))}))}().then((e=>{})),"updateScrape"===s.msg&&await async function(e){chrome.storage.session.get("config",(async function(t){const o=t.config;await fetch("http://"+o["remote-address"]+"/api/updateScrape",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{Authorization:"Bearer null","Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(e)}).then((e=>e.json())).then((e=>{}))}))}(s.data),"deleteScrape"===s.msg&&await async function(e){chrome.storage.session.get("config",(async function(t){const o=t.config;await fetch("http://"+o["remote-address"]+"/api/deleteScrape",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{Authorization:"Bearer null","Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(e)}).then((e=>e.json())).then((e=>{console.log(e)}))}))}(s.data),"Bring back scrape builder"===s.msg&&chrome.tabs.query({},(async function(e){var t=0;e.forEach((o=>{-1!=c("scrapeBuilder",o.url)&&chrome.windows.update(e[t].windowId,{focused:!0}),t++}))})),"Bring back popup"===s.msg&&(chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(e){var t=e[0];chrome.tabs.remove(t.id)})),chrome.tabs.create({url:chrome.runtime.getURL("popup.html"),active:!1},(async function(e){await chrome.windows.create({tabId:e.id,type:"popup",focused:!0,height:628,width:628})})),n+=1,chrome.storage.sync.set({disableSelect:n})),"Bring up active tab"===s.msg&&chrome.tabs.query({active:!0,currentWindow:!1},(async function(e){var t=0;e.forEach((o=>{-1!=c(a.url,o.url)&&chrome.windows.update(e[t].windowId,{focused:!0}),t++}))}))}))})();